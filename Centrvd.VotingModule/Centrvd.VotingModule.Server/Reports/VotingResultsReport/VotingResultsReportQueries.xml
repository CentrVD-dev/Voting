<?xml version="1.0" encoding="utf-8"?>
<queries>
  <query key="SelectVotingResults">
    <mssql><![CDATA[SELECT
    CASE 
        WHEN res2.name IS NOT NULL THEN CONCAT(res1.name, ' за ', res2.name)
        ELSE res1.name
    END AS voter,
    v.name AS vote,
    COALESCE(vr.comment, '') AS comment,
    vr.pointid AS decisionid,
    vr.text AS decision,
    (
        SELECT STUFF(
            (SELECT ', ' + v2.name + ' - ' + CAST(COUNT(*) AS VARCHAR(10))
             FROM centrvd_votingm_votingtaskvoti AS vr2
             JOIN centrvd_votingm_votekind AS v2 ON v2.id = vr2.vote
             WHERE vr2.pointid = vr.pointid AND vr2.task = @taskid
             GROUP BY v2.name, v2.id
             ORDER BY v2.id
             FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '')
    ) AS summary
FROM centrvd_votingm_votingtaskvoti AS vr
JOIN sungero_core_recipient AS res1 ON res1.id = vr.voter
LEFT JOIN sungero_core_recipient AS res2 ON res2.id = vr.substituted
JOIN centrvd_votingm_votekind AS v ON v.id = vr.vote
WHERE vr.task = @taskid
ORDER BY vr.pointid, voter]]></mssql>
    <postgres><![CDATA[select
    case 
        when res2.name is not null then concat(res1.name, ' за ', res2.name)
        else res1.name
    end as voter,
    v.name as vote,
    coalesce(vr.comment, '') as comment,
    vr.pointid as decisionid,
    vr.text as decision,
    (
        select string_agg(vote_info, ', ')
        from (
            select v2.name || ' - ' || count(*)::text as vote_info
            from centrvd_votingm_votingtaskvoti as vr2
            join centrvd_votingm_votekind as v2 on v2.id = vr2.vote
            where vr2.pointid = vr.pointid and vr2.task = @taskid
            group by v2.name, v2.id
            order by v2.id
        ) as sub
    ) as summary
from centrvd_votingm_votingtaskvoti as vr
join sungero_core_recipient as res1 on res1.id = vr.voter
left join sungero_core_recipient as res2 on res2.id = vr.substituted
join centrvd_votingm_votekind as v on v.id = vr.vote
where vr.task = @taskid
order by vr.pointid, voter]]></postgres>
  </query>
</queries>